<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="HttpServletRequestWrapper요즘 웹 애플리케이션에서는 보안을 위한 다양한 방법이 존재한다. 어떠한 요청을 처리하기 전에 이 사용자가 권한을 가지고 있는지 확인하기 위해 해당 메소드가 호출되기전에 권한 인증을 하게 된다. 나는 JWT를 이용해서 token 인증 방식...">
  <meta name="keywords" content="민동현 and spring">
  <meta name="author" content="HttpServletRequestWrapper | 민동현의 블로그">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#f5f5f5">

  <!-- Twitter Tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="HttpServletRequestWrapper | 민동현의 블로그">
  <meta name="twitter:description" content="HttpServletRequestWrapper요즘 웹 애플리케이션에서는 보안을 위한 다양한 방법이 존재한다. 어떠한 요청을 처리하기 전에 이 사용자가 권한을 가지고 있는지 확인하기 위해 해당 메소드가 호출되기전에 권한 인증을 하게 된다. 나는 JWT를 이용해서 token 인증 방식...">
  
    <meta property="twitter:image" content="http://localhost:4000/img/leonids-logo.png">
  

  <!-- Open Graph Tags -->
  <meta property="og:type" content="blog">
  <meta property="og:url" content="http://localhost:4000/articles/2019-01/HttpServletRequestWrapper">
  <meta property="og:title" content="HttpServletRequestWrapper | 민동현의 블로그">
  <meta property="og:description" content="HttpServletRequestWrapper요즘 웹 애플리케이션에서는 보안을 위한 다양한 방법이 존재한다. 어떠한 요청을 처리하기 전에 이 사용자가 권한을 가지고 있는지 확인하기 위해 해당 메소드가 호출되기전에 권한 인증을 하게 된다. 나는 JWT를 이용해서 token 인증 방식...">
  
    <meta property="og:image" content="http://localhost:4000/img/leonids-logo.png">
  
  <title>HttpServletRequestWrapper | 민동현의 블로그</title>

  <!-- CSS files -->
  <link rel="stylesheet" href="http://localhost:4000/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://localhost:4000/css/main.css">

  <link rel="canonical" href="http://localhost:4000/articles/2019-01/HttpServletRequestWrapper">
  <link rel="alternate" type="application/rss+xml" title="민동현의 블로그" href="http://localhost:4000/feed.xml" />

  <!-- Icons -->
  <!-- 16x16 -->
  <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
  <!-- 32x32 -->
  <link rel="shortcut icon" href="http://localhost:4000/favicon.png">
</head>


<body>
  <div class="row">
    <div class="col s12 m3">
      <div class="table cover">
        

<div class="cover-card table-cell table-middle">
  
  <a href="http://localhost:4000/">
    <img src="http://localhost:4000/img/profile.jpg" alt="" class="avatar">
  </a>
  
  <a href="http://localhost:4000/" class="author_name">민동현</a>
  <span class="author_job">Back End Developer</span>
  <span class="author_bio mbm">JAVA 개발자</span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="http://localhost:4000/">home</a>
      </li>
       
      <li class="nav-item">
        <a href="http://localhost:4000/archive/">Archive</a>
      </li>
          
      <li class="nav-item">
        <a href="http://localhost:4000/categories/">Categories</a>
      </li>
             
    </ul>
  </nav>
  <script type="text/javascript">
  // based on http://stackoverflow.com/a/10300743/280842
  function gen_mail_to_link(hs, subject) {
    var lhs,rhs;
    var p = hs.split('@');
    lhs = p[0];
    rhs = p[1];
    document.write("<a class=\"social-link-item\" target=\"_blank\" href=\"mailto");
    document.write(":" + lhs + "@");
    document.write(rhs + "?subject=" + subject + "\"><i class=\"fa fa-fw fa-envelope\"></i><\/a>");
  }
</script>
<div class="social-links">
  <ul>
    
      <li>
      <script>gen_mail_to_link('mindh890@gmail.com', 'Hello from website');</script>
      </li>
    
    
    
    
    <li><a href="http://linkedin.com/in/동현-민-736913183" class="social-link-item" target="_blank"><i class="fa fa-fw fa-linkedin"></i></a></li>
    
    
    
    
    <li><a href="http://github.com/DaeAkin" class="social-link-item" target="_blank"><i class="fa fa-fw fa-github"></i></a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li><a href="https://t.me/DonghyeonMin" class="social-link-item" target="_blank"><i class="fa fa-fw fa-telegram"></i></a></li>
  </ul>
</div>

</div>

      </div>
    </div>
    <div class="col s12 m9">
      <div class="post-listing">
        <a class="btn" href= "http://localhost:4000/" >
  Home
</a>



<div id="post">
  <header class="post-header">
    <h1 title="HttpServletRequestWrapper">HttpServletRequestWrapper</h1>
    <span class="post-meta">
      <span class="post-date">
        13 JAN 2019
      </span>
      •
      <span class="read-time" title="Estimated read time">
  
  
    5 mins read
  
</span>

    </span>

  </header>

  <article class="post-content">
    <h2 id="httpservletrequestwrapper">HttpServletRequestWrapper</h2>

<p>요즘 웹 애플리케이션에서는 보안을 위한 다양한 방법이 존재한다. 어떠한 요청을 처리하기 전에 이 사용자가 권한을 가지고 있는지 확인하기 위해 해당 메소드가 호출되기전에 권한 인증을 하게 된다. 나는 JWT를 이용해서 token 인증 방식을 이용했는데, 메소드를 호출하기전에 token을 인증하는 방식이다. 클라이언트는 헤더나 request 객체에 담아 token의 값을 서버로 보낸다.
	하지만 문제가 있는데 넘어온 request 객체는 InputStream에 의해 읽혀진다. 인증 과정에서 request를 읽어 버리면 이 request는 더 이상 읽을 수가 없게 된다. 톰캣에서 막아놨기 때문이다. request를 읽지 못하여 인증에 성공하더라도 그 이후 과정에서(Controller가 request를 다시 읽는 다던지) 다시 사용하지 못한다. 
	이 방법을 해결하기 위해서는 <code class="language-plaintext highlighter-rouge">javax.servlet.http</code>에 있는 <code class="language-plaintext highlighter-rouge">HttpServletRequestWrapper</code>를 이용해서 wrapper클래스를 만들면 된다.</p>

<blockquote>
  <p>JsonRequestWrapper</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ByteArrayInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequestWrapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.core.JsonGenerationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.core.type.TypeReference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.JsonMappingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JsonRequestWrapper</span> <span class="kd">extends</span> <span class="nc">HttpServletRequestWrapper</span> <span class="o">{</span>

	 <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">body</span><span class="o">;</span>
	 
	    <span class="kd">public</span> <span class="nf">JsonRequestWrapper</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span>
	    <span class="o">{</span>
	        <span class="c1">//So that other request method behave just like before</span>
	        <span class="kd">super</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
	         
	        <span class="nc">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
	        <span class="nc">BufferedReader</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	        <span class="k">try</span> <span class="o">{</span>
	            <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
	            <span class="k">if</span> <span class="o">(</span><span class="n">inputStream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	                <span class="n">bufferedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>
	                <span class="kt">char</span><span class="o">[]</span> <span class="n">charBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="mi">128</span><span class="o">];</span>
	                <span class="kt">int</span> <span class="n">bytesRead</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
	                <span class="k">while</span> <span class="o">((</span><span class="n">bytesRead</span> <span class="o">=</span> <span class="n">bufferedReader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">charBuffer</span><span class="o">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
	                    <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">charBuffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bytesRead</span><span class="o">);</span>
	                <span class="o">}</span>
	            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
	                <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
	            <span class="o">}</span>
	        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
	            <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
	        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
	            <span class="k">if</span> <span class="o">(</span><span class="n">bufferedReader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	                <span class="k">try</span> <span class="o">{</span>
	                    <span class="n">bufferedReader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
	                    <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
	                <span class="o">}</span>
	            <span class="o">}</span>
	        <span class="o">}</span>
	        <span class="c1">//Store request pody content in 'body' variable</span>
	        <span class="n">body</span> <span class="o">=</span> <span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
	    <span class="o">}</span>
	 
	    <span class="nd">@Override</span>
	    <span class="kd">public</span> <span class="nc">ServletInputStream</span> <span class="nf">getInputStream</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
	        <span class="kd">final</span> <span class="nc">ByteArrayInputStream</span> <span class="n">byteArrayInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">body</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
	        <span class="nc">ServletInputStream</span> <span class="n">servletInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServletInputStream</span><span class="o">()</span> <span class="o">{</span>
	            <span class="kd">public</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
	                <span class="k">return</span> <span class="n">byteArrayInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
	            <span class="o">}</span>
	        <span class="o">};</span>
	        <span class="k">return</span> <span class="n">servletInputStream</span><span class="o">;</span>
	    <span class="o">}</span>
	 
	    <span class="nd">@Override</span>
	    <span class="kd">public</span> <span class="nc">BufferedReader</span> <span class="nf">getReader</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
	        <span class="k">return</span> <span class="k">new</span> <span class="nf">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
	    <span class="o">}</span>
	 
	    <span class="c1">//Use this method to read the request body N times</span>
	    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getBody</span><span class="o">()</span> <span class="o">{</span>
	        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">body</span><span class="o">;</span>
	    <span class="o">}</span>

	<span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">jsonToMap</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>

			<span class="nc">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>

			<span class="c1">// read JSON from a file</span>
			 <span class="n">map</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span>
					<span class="n">body</span><span class="o">,</span> 
					<span class="k">new</span> <span class="nc">TypeReference</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
			<span class="o">});</span>



		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JsonGenerationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JsonMappingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
	

		<span class="k">return</span> <span class="n">map</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>나는 filter를 이용해서 token 인증을 구현했다.</p>

<blockquote>
  <p>JWTFilter</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JWTFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span><span class="o">{</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">FilterConfig</span> <span class="n">config</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---- init call ----"</span><span class="o">);</span>
		
	<span class="o">}</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
		

<span class="c1">//		 Wrapper 생성.</span>
		<span class="nc">JsonRequestWrapper</span> <span class="n">jrw</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JsonRequestWrapper</span><span class="o">((</span><span class="nc">HttpServletRequest</span><span class="o">)</span><span class="n">request</span><span class="o">);</span>
			
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---- doFilter ----"</span><span class="o">);</span>
		
        <span class="c1">//필자는 header를 이용했다.</span>
		<span class="nc">String</span> <span class="n">loginToken</span> <span class="o">=</span> <span class="n">jrw</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"token"</span><span class="o">);</span>
		
		<span class="nc">JWTUtil</span><span class="o">.</span><span class="na">verifyToken</span><span class="o">(</span><span class="n">loginToken</span><span class="o">);</span>
			
		<span class="c1">// getbody()를 이용해서 wrapper에 담긴 값들을 가져온다.	</span>
		<span class="n">jrw</span><span class="o">.</span><span class="na">getbody</span><span class="o">();</span>
		
        <span class="c1">// 그 후에 request를 이용해야할 메소드들에게 wrapper에 담긴내용들을 전달해준다.</span>
		<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">jrw</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// TODO Auto-generated method stub</span>
		
	<span class="o">}</span>


<span class="o">}</span>

</code></pre></div></div>


  </article>
</div><!-- <div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/articles/2019-01/HttpServletRequestWrapper" class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/articles/2019-01/HttpServletRequestWrapper" class="facebook btn" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://localhost:4000/articles/2019-01/HttpServletRequestWrapper" class="google-plus btn" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
    <li>
      <a href="https://news.ycombinator.com/submitlink?u=http://localhost:4000/articles/2019-01/HttpServletRequestWrapper" class="hacker-news btn" title="Share on Hacker News"><i class="fa fa-hacker-news"></i><span> Hacker News</span></a>
    </li>
    <li>
      <a href="https://www.reddit.com/submit?url=http://localhost:4000/articles/2019-01/HttpServletRequestWrapper" class="reddit btn" title="Share on Reddit"><i class="fa fa-reddit"></i><span> Reddit</span></a>
    </li>
  </ul>
</div><!-- end share-buttons --> 


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'daeakin';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



        <footer>
  &copy; 2019 민동현 <i class="fa fa-heart heart-icon"></i>
</footer>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="http://localhost:4000/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="http://localhost:4000/js/main.js"></script>


</body>
</html>
